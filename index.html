<script>
    const N8N_URL = 'https://apps.villaitue.cl/webhook-test/autoservicio';
    const viewer = document.getElementById('viewer');
    const textDisplay = document.getElementById('transcription');
    const btn = document.getElementById('btn-micro');

    // --- 1. FONDO PORTAL (CORREGIDO) ---
    const fotosPortal = [
        'https://vsn47925-tech.github.io/img/servicio/portal-entrada.jpg',
        'https://vsn47925-tech.github.io/img/servicio/portal-recep.jpg',
        'https://vsn47925-tech.github.io/img/servicio/portal-villa.jpg',
        'https://vsn47925-tech.github.io/img/servicio/portal-volcan.jpg'
    ];
    let currentPortal = 0;

    const aplicarFondo = (url) => {
        document.body.style.backgroundImage = `linear-gradient(rgba(15, 23, 42, 0.7), rgba(15, 23, 42, 0.7)), url('${url}')`;
    };

    // Iniciar y rotar portal
    aplicarFondo(fotosPortal[0]);
    setInterval(() => {
        currentPortal = (currentPortal + 1) % fotosPortal.length;
        aplicarFondo(fotosPortal[currentPortal]);
    }, 10000);

    // --- 2. VOZ CHILENA DE DON ATILIO (CORREGIDO) ---
    const hablarDonAtilio = (texto) => {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(texto);
        const voces = window.speechSynthesis.getVoices();

        // Buscar voz chilena (es-CL), si no, una mexicana (es-MX) que es menos "española"
        const vozChilena = voces.find(v => v.lang === 'es-CL') || 
                           voces.find(v => v.lang === 'es-MX') || 
                           voces.find(v => v.lang.includes('es'));
        
        utterance.voice = vozChilena;
        utterance.pitch = 0.75; // Voz más profunda/grave
        utterance.rate = 0.8;   // Habla más lento y pausado
        window.speechSynthesis.speak(utterance);
    };

    // --- 3. PROCESAMIENTO DE RESPUESTA Y CARRUSEL ---
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'es-CL';

    recognition.onresult = async (event) => {
        const query = event.results[0][0].transcript;
        textDisplay.innerText = `Usted: "${query}"`;
        
        try {
            const response = await fetch(N8N_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });

            const rawData = await response.json();
            let finalData;

            // ESTO LIMPIA EL JSON DOBLE QUE ME MOSTRASTE
            const dataNode = Array.isArray(rawData) ? rawData[0] : rawData;
            finalData = typeof dataNode.output === 'string' && dataNode.output.includes('{') 
                ? JSON.parse(dataNode.output) 
                : dataNode;

            // Ejecutar Voz e Imagen
            hablarDonAtilio(finalData.output);
            viewer.innerHTML = renderizarCarrusel(finalData);

        } catch (error) {
            console.error("Error:", error);
        }
    };

    const renderizarCarrusel = (data) => {
        if (!data.imagenes || data.imagenes.length === 0) {
            return `<div class="bg-slate-900/80 p-6 rounded-2xl text-white text-xl">${data.output}</div>`;
        }
        return `
        <div class="flex flex-col gap-4 animate-in zoom-in duration-500 max-w-md w-full">
            <div class="relative overflow-hidden rounded-[2rem] shadow-2xl border-4 border-white/10 bg-slate-900 aspect-video">
                <div class="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide h-full">
                    ${data.imagenes.map(img => `
                        <div class="snap-center shrink-0 w-full h-full">
                            <img src="${img}" class="w-full h-full object-cover">
                        </div>
                    `).join('')}
                </div>
            </div>
            <div class="bg-slate-900/90 backdrop-blur-md p-6 rounded-[2rem] border border-white/10 text-left shadow-xl">
                <h3 class="text-xl font-bold text-blue-400">${data.titulo}</h3>
                <p class="text-slate-200 text-sm mt-2">${data.descripcion}</p>
                <p class="text-lg font-bold text-white mt-3">${data.precio || ''}</p>
            </div>
        </div>`;
    };

    btn.onclick = () => { try { recognition.start(); } catch(e) {} };
    // Importante para cargar voces en algunos navegadores
    window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
</script>
